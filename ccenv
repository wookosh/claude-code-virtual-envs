#!/usr/bin/env bash
set -euo pipefail

# ccenv — Claude Code Environments
# Manages reusable configuration profiles for Claude Code.

VERSION="1.0.0"
PROFILES_DIR="${HOME}/.claude-profiles"
PROFILE_MARKER=".profile"

# Files/dirs that belong to a profile (managed by ccenv)
PROFILE_FILES=("settings.json" "CLAUDE.md")
PROFILE_DIRS=("agents" "skills" "rules")

# ─── Helpers ───────────────────────────────────────────────────────────────────

die() { printf 'ccenv: %b\n' "$*" >&2; exit 1; }

confirm() {
    local prompt="${1:-Continue?}"
    printf '%s [y/N] ' "$prompt" >&2
    read -r answer
    [[ "$answer" =~ ^[Yy]$ ]]
}

ensure_profiles_dir() {
    if [[ ! -d "$PROFILES_DIR" ]]; then
        mkdir -p "$PROFILES_DIR/_default"
        cat > "$PROFILES_DIR/_default/settings.json" <<'DEFAULTSETTINGS'
{}
DEFAULTSETTINGS
        cat > "$PROFILES_DIR/_default/CLAUDE.md" <<'DEFAULTMD'
# Claude Code

Add your system instructions here.
DEFAULTMD
        mkdir -p "$PROFILES_DIR/_default/agents"
        mkdir -p "$PROFILES_DIR/_default/skills"
        mkdir -p "$PROFILES_DIR/_default/rules"
        printf 'Created %s with _default profile.\n' "$PROFILES_DIR"
        printf 'Tip: run "ccenv save original --from global" to preserve your existing config.\n'
    fi
}

# Compute a sha256 hash of all profile-managed content in a directory.
# Usage: compute_hash <dir>
compute_hash() {
    local dir="$1"
    (
        cd "$dir"
        # Collect all profile-managed files, sort for determinism, hash contents
        {
            for f in "${PROFILE_FILES[@]}"; do
                [[ -f "$f" ]] && cat "$f"
            done
            for d in "${PROFILE_DIRS[@]}"; do
                if [[ -d "$d" ]]; then
                    find "$d" -type f | sort | while IFS= read -r file; do
                        cat "$file"
                    done
                fi
            done
        } | sha256sum | awk '{print $1}'
    )
}

# Copy profile-managed files from src to dst.
# Usage: copy_profile_files <src> <dst>
copy_profile_files() {
    local src="$1" dst="$2"
    mkdir -p "$dst"
    for f in "${PROFILE_FILES[@]}"; do
        if [[ -f "$src/$f" ]]; then
            cp "$src/$f" "$dst/$f"
        fi
    done
    for d in "${PROFILE_DIRS[@]}"; do
        if [[ -d "$src/$d" ]]; then
            rm -rf "$dst/$d"
            cp -r "$src/$d" "$dst/$d"
        fi
    done
}

# Remove profile-managed files from a directory, preserving .local files.
# Usage: remove_profile_files <dir>
remove_profile_files() {
    local dir="$1"
    for f in "${PROFILE_FILES[@]}"; do
        [[ -f "$dir/$f" ]] && rm -f "$dir/$f"
    done
    for d in "${PROFILE_DIRS[@]}"; do
        [[ -d "$dir/$d" ]] && rm -rf "$dir/$d"
    done
}

# Write the .profile marker file.
# Usage: write_marker <claude_dir> <profile_name> <hash>
write_marker() {
    local dir="$1" name="$2" hash="$3"
    printf '%s\n%s\n' "$name" "$hash" > "$dir/$PROFILE_MARKER"
}

# Read the .profile marker. Sets MARKER_NAME and MARKER_HASH.
# Returns 1 if no marker exists.
read_marker() {
    local dir="$1"
    if [[ ! -f "$dir/$PROFILE_MARKER" ]]; then
        return 1
    fi
    MARKER_NAME="$(sed -n '1p' "$dir/$PROFILE_MARKER")"
    MARKER_HASH="$(sed -n '2p' "$dir/$PROFILE_MARKER")"
}

# Count items in a profile dir for listing.
count_items() {
    local dir="$1" subdir="$2"
    if [[ -d "$dir/$subdir" ]]; then
        find "$dir/$subdir" -type f -name '*.md' 2>/dev/null | wc -l | tr -d ' '
    else
        echo 0
    fi
}

# ─── Commands ──────────────────────────────────────────────────────────────────

cmd_save() {
    local name=""
    local from="global"

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --from)
                shift
                from="${1:-}"
                [[ -z "$from" ]] && die "save: --from requires a value (global|project)"
                ;;
            -*)
                die "save: unknown option '$1'"
                ;;
            *)
                [[ -z "$name" ]] && name="$1" || die "save: unexpected argument '$1'"
                ;;
        esac
        shift
    done

    [[ -z "$name" ]] && die "save: profile name required\nUsage: ccenv save <name> [--from global|project]"

    ensure_profiles_dir

    local source_dir
    case "$from" in
        global)  source_dir="${HOME}/.claude" ;;
        project) source_dir="$(pwd)/.claude" ;;
        *)       die "save: --from must be 'global' or 'project'" ;;
    esac

    [[ -d "$source_dir" ]] || die "save: source directory '$source_dir' does not exist"

    local profile_dir="$PROFILES_DIR/$name"
    if [[ -d "$profile_dir" ]]; then
        confirm "Profile '$name' already exists. Overwrite?" || { echo "Aborted."; exit 0; }
        rm -rf "$profile_dir"
    fi

    mkdir -p "$profile_dir"
    copy_profile_files "$source_dir" "$profile_dir"

    printf 'Profile "%s" saved from %s config.\n' "$name" "$from"
    printf 'Location: %s\n' "$profile_dir"
}

cmd_use() {
    local name=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -*)  die "use: unknown option '$1'" ;;
            *)
                [[ -z "$name" ]] && name="$1" || die "use: unexpected argument '$1'"
                ;;
        esac
        shift
    done

    [[ -z "$name" ]] && die "use: profile name required\nUsage: ccenv use <name>"

    ensure_profiles_dir

    local profile_dir="$PROFILES_DIR/$name"
    [[ -d "$profile_dir" ]] || die "use: profile '$name' not found in $PROFILES_DIR"

    local claude_dir="$(pwd)/.claude"

    # Check existing .claude/ state
    if [[ -d "$claude_dir" ]]; then
        if [[ -f "$claude_dir/$PROFILE_MARKER" ]]; then
            read_marker "$claude_dir"
            if [[ "$MARKER_NAME" == "$name" ]]; then
                confirm "Profile '$name' is already active. Re-apply?" || { echo "Aborted."; exit 0; }
            else
                confirm "Profile '$MARKER_NAME' is currently active. Switch to '$name'?" || { echo "Aborted."; exit 0; }
            fi
        else
            # .claude/ exists but no marker — check if it has managed content
            local has_content=false
            for f in "${PROFILE_FILES[@]}"; do
                [[ -f "$claude_dir/$f" ]] && has_content=true
            done
            for d in "${PROFILE_DIRS[@]}"; do
                [[ -d "$claude_dir/$d" ]] && has_content=true
            done
            if $has_content; then
                printf 'Warning: .claude/ has untracked config (no profile marker).\n'
                printf 'Consider running "ccenv save <name> --from project" first to preserve it.\n'
                confirm "Overwrite managed files?" || { echo "Aborted."; exit 0; }
            fi
        fi
    fi

    # Remove profile-managed files, then copy new profile
    if [[ -d "$claude_dir" ]]; then
        remove_profile_files "$claude_dir"
    fi
    copy_profile_files "$profile_dir" "$claude_dir"

    # Write marker
    local hash
    hash="$(compute_hash "$profile_dir")"
    write_marker "$claude_dir" "$name" "$hash"

    printf 'Profile "%s" applied to .claude/\n' "$name"
    printf 'Launch Claude Code with: claude --setting-sources project,local\n'
}

cmd_eject() {
    local claude_dir="$(pwd)/.claude"

    [[ -f "$claude_dir/$PROFILE_MARKER" ]] || die "eject: no active profile in this project"

    read_marker "$claude_dir"
    rm -f "$claude_dir/$PROFILE_MARKER"

    printf 'Ejected from profile "%s".\n' "$MARKER_NAME"
    printf 'Project is now independent. Changes here won'\''t affect the profile.\n'
}

cmd_status() {
    ensure_profiles_dir

    local claude_dir="$(pwd)/.claude"

    if [[ -f "$claude_dir/$PROFILE_MARKER" ]]; then
        read_marker "$claude_dir"
        printf 'Active profile: %s\n' "$MARKER_NAME"

        local profile_dir="$PROFILES_DIR/$MARKER_NAME"
        if [[ -d "$profile_dir" ]]; then
            local current_hash template_hash
            # Hash the profile-managed files in the project
            current_hash="$(compute_hash "$claude_dir")"
            template_hash="$(compute_hash "$profile_dir")"

            if [[ "$current_hash" == "$MARKER_HASH" && "$current_hash" == "$template_hash" ]]; then
                printf 'Status: in sync with template\n'
            else
                if [[ "$current_hash" != "$MARKER_HASH" ]]; then
                    printf 'Status: project files have drifted from applied profile\n'
                fi
                if [[ "$template_hash" != "$MARKER_HASH" ]]; then
                    printf 'Status: profile template has been updated since last apply\n'
                fi
                printf 'Run "ccenv update" to re-sync or "ccenv diff" to see changes.\n'
            fi
        else
            printf 'Warning: profile "%s" no longer exists in %s\n' "$MARKER_NAME" "$PROFILES_DIR"
        fi
    else
        printf 'No profile active in this project.\n'
    fi

    echo ""
    printf 'Available profiles:\n'
    cmd_list
}

cmd_update() {
    local claude_dir="$(pwd)/.claude"

    [[ -f "$claude_dir/$PROFILE_MARKER" ]] || die "update: no active profile in this project"

    read_marker "$claude_dir"
    local name="$MARKER_NAME"
    local profile_dir="$PROFILES_DIR/$name"

    [[ -d "$profile_dir" ]] || die "update: profile '$name' not found in $PROFILES_DIR"

    # Show what would change
    printf 'Comparing project .claude/ against profile "%s"...\n\n' "$name"

    local has_changes=false

    # Check files
    for f in "${PROFILE_FILES[@]}"; do
        local pf="$profile_dir/$f"
        local cf="$claude_dir/$f"
        if [[ -f "$pf" && -f "$cf" ]]; then
            if ! diff -q "$pf" "$cf" >/dev/null 2>&1; then
                printf '  modified: %s\n' "$f"
                has_changes=true
            fi
        elif [[ -f "$pf" && ! -f "$cf" ]]; then
            printf '  added:    %s\n' "$f"
            has_changes=true
        elif [[ ! -f "$pf" && -f "$cf" ]]; then
            printf '  removed:  %s\n' "$f"
            has_changes=true
        fi
    done

    # Check dirs
    for d in "${PROFILE_DIRS[@]}"; do
        local pd="$profile_dir/$d"
        local cd_="$claude_dir/$d"
        if [[ -d "$pd" ]]; then
            # Files in profile but not in project
            (cd "$pd" && find . -type f | sort) | while IFS= read -r rf; do
                rf="${rf#./}"
                if [[ ! -f "$cd_/$rf" ]]; then
                    printf '  added:    %s/%s\n' "$d" "$rf"
                    has_changes=true
                elif ! diff -q "$pd/$rf" "$cd_/$rf" >/dev/null 2>&1; then
                    printf '  modified: %s/%s\n' "$d" "$rf"
                    has_changes=true
                fi
            done
        fi
        if [[ -d "$cd_" ]]; then
            # Files in project but not in profile
            (cd "$cd_" && find . -type f | sort) | while IFS= read -r rf; do
                rf="${rf#./}"
                if [[ ! -d "$pd" ]] || [[ ! -f "$pd/$rf" ]]; then
                    printf '  removed:  %s/%s\n' "$d" "$rf"
                    has_changes=true
                fi
            done
        fi
    done

    # has_changes may be set inside subshells — re-check by comparing hashes
    local current_hash template_hash
    current_hash="$(compute_hash "$claude_dir")"
    template_hash="$(compute_hash "$profile_dir")"

    if [[ "$current_hash" == "$template_hash" ]]; then
        printf 'Already up to date.\n'
        return
    fi

    echo ""
    confirm "Apply changes from profile '$name'?" || { echo "Aborted."; exit 0; }

    remove_profile_files "$claude_dir"
    copy_profile_files "$profile_dir" "$claude_dir"

    local new_hash
    new_hash="$(compute_hash "$profile_dir")"
    write_marker "$claude_dir" "$name" "$new_hash"

    printf 'Updated to latest "%s" profile.\n' "$name"
}

cmd_list() {
    ensure_profiles_dir

    local found=false
    for profile_dir in "$PROFILES_DIR"/*/; do
        [[ -d "$profile_dir" ]] || continue
        found=true
        local name
        name="$(basename "$profile_dir")"
        local agents skills rules has_claude_md

        agents="$(count_items "$profile_dir" "agents")"
        skills="$(find "$profile_dir/skills" -name 'SKILL.md' 2>/dev/null | wc -l | tr -d ' ')"
        rules="$(count_items "$profile_dir" "rules")"

        if [[ -f "$profile_dir/CLAUDE.md" ]]; then
            has_claude_md="yes"
        else
            has_claude_md="no"
        fi

        printf '  %-20s  agents:%s  skills:%s  rules:%s  CLAUDE.md:%s\n' \
            "$name" "$agents" "$skills" "$rules" "$has_claude_md"
    done

    if ! $found; then
        printf '  (no profiles found)\n'
    fi
}

cmd_diff() {
    local name=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -*)  die "diff: unknown option '$1'" ;;
            *)
                [[ -z "$name" ]] && name="$1" || die "diff: unexpected argument '$1'"
                ;;
        esac
        shift
    done

    ensure_profiles_dir

    local claude_dir="$(pwd)/.claude"
    [[ -d "$claude_dir" ]] || die "diff: no .claude/ directory in current project"

    # Default to active profile if no name given
    if [[ -z "$name" ]]; then
        if [[ -f "$claude_dir/$PROFILE_MARKER" ]]; then
            read_marker "$claude_dir"
            name="$MARKER_NAME"
        else
            die "diff: no profile name given and no active profile. Usage: ccenv diff [name]"
        fi
    fi

    local profile_dir="$PROFILES_DIR/$name"
    [[ -d "$profile_dir" ]] || die "diff: profile '$name' not found"

    printf 'Comparing .claude/ against profile "%s":\n\n' "$name"

    local any_diff=false

    # Compare files
    for f in "${PROFILE_FILES[@]}"; do
        local pf="$profile_dir/$f"
        local cf="$claude_dir/$f"
        if [[ -f "$pf" && -f "$cf" ]]; then
            if ! diff -q "$pf" "$cf" >/dev/null 2>&1; then
                printf '=== %s ===\n' "$f"
                diff -u "$pf" "$cf" --label "profile:$f" --label "project:$f" || true
                echo ""
                any_diff=true
            fi
        elif [[ -f "$pf" && ! -f "$cf" ]]; then
            printf '=== %s (only in profile) ===\n\n' "$f"
            any_diff=true
        elif [[ ! -f "$pf" && -f "$cf" ]]; then
            printf '=== %s (only in project) ===\n\n' "$f"
            any_diff=true
        fi
    done

    # Compare dirs
    for d in "${PROFILE_DIRS[@]}"; do
        local pd="$profile_dir/$d"
        local cd_="$claude_dir/$d"

        # Collect all relative file paths from both
        local all_files=()
        if [[ -d "$pd" ]]; then
            while IFS= read -r rf; do
                all_files+=("${rf#./}")
            done < <(cd "$pd" && find . -type f | sort)
        fi
        if [[ -d "$cd_" ]]; then
            while IFS= read -r rf; do
                all_files+=("${rf#./}")
            done < <(cd "$cd_" && find . -type f | sort)
        fi

        # Deduplicate
        local unique_files
        unique_files="$(printf '%s\n' "${all_files[@]}" 2>/dev/null | sort -u)" || true

        while IFS= read -r rf; do
            [[ -z "$rf" ]] && continue
            local pf="$pd/$rf"
            local cf="$cd_/$rf"
            if [[ -f "$pf" && -f "$cf" ]]; then
                if ! diff -q "$pf" "$cf" >/dev/null 2>&1; then
                    printf '=== %s/%s ===\n' "$d" "$rf"
                    diff -u "$pf" "$cf" --label "profile:$d/$rf" --label "project:$d/$rf" || true
                    echo ""
                    any_diff=true
                fi
            elif [[ -f "$pf" && ! -f "$cf" ]]; then
                printf '=== %s/%s (only in profile) ===\n\n' "$d" "$rf"
                any_diff=true
            elif [[ ! -f "$pf" && -f "$cf" ]]; then
                printf '=== %s/%s (only in project) ===\n\n' "$d" "$rf"
                any_diff=true
            fi
        done <<< "$unique_files"
    done

    if ! $any_diff; then
        printf 'No differences found.\n'
    fi
}

cmd_help() {
    cat <<'HELP'
ccenv — Claude Code Environments

Manage reusable configuration profiles for Claude Code.

Usage:
  ccenv <command> [arguments]

Commands:
  save <name> [--from global|project]   Save current config as a profile
  use <name>                            Apply a profile to the current project
  eject                                 Detach project from its profile
  status                                Show profile state for this project
  update                                Re-sync project from profile template
  list                                  List all available profiles
  diff [name]                           Compare project config against a profile
  help                                  Show this help message
  version                               Show version

Shell integration:
  Add to your .bashrc or .zshrc to auto-apply --setting-sources:

    claude() {
      if [ -f ".claude/.profile" ]; then
        command claude --setting-sources project,local "$@"
      else
        command claude "$@"
      fi
    }

HELP
}

cmd_version() {
    printf 'ccenv %s\n' "$VERSION"
}

# ─── Main ──────────────────────────────────────────────────────────────────────

main() {
    local cmd="${1:-help}"
    shift 2>/dev/null || true

    case "$cmd" in
        save)    cmd_save "$@" ;;
        use)     cmd_use "$@" ;;
        eject)   cmd_eject ;;
        status)  cmd_status ;;
        update)  cmd_update ;;
        list)    cmd_list ;;
        diff)    cmd_diff "$@" ;;
        help|--help|-h)    cmd_help ;;
        version|--version|-v) cmd_version ;;
        *)       die "unknown command '$cmd'. Run 'ccenv help' for usage." ;;
    esac
}

main "$@"
